## ClickHouse: сгенерировать строки с датами, имея дату начала и дату конца периода

**Варианты решения**: [здесь](https://github.com/Malakhova-Natalya/Snippets/blob/main/clickhouse_date_range/01%20-%20генерация%20строк%20с%20датами.txt)

## ClickHouse: заменить пропуски последним значением

Рабочая ситуация: есть данные из JagaJam. В них для соцсетей (VK, TG) есть данные об активности пользователей. Например, дата, соцсеть, кол-во подписчиков, кол-во просмотров, лайков, комментариев и тд. Но если в какую-либо дату активностей не было → не будет строки. Поэтому для не очень активных групп бывают ситуации, когда активности не было → не было строки с такой датой → и если мы строим график с числом подписчиков, у нас из-за этого появляются провалы. А это неверно - раз активности не было, это не значит, что все подписчики испарились в эту дату.

Получается, у нас есть некоторое количество пропусков, которые нужно заполнить.
Сначала мы генерируем даты и присоединяем даты без пропусков к основным данным. (Варианты решения [здесь](https://github.com/Malakhova-Natalya/Snippets/blob/main/clickhouse_date_range/01%20-%20генерация%20строк%20с%20датами.txt)).

Затем у нас есть все даты, но в некоторые нам не хватает подписчиков. Чтобы на графике не было пропусков, нам нужно их заполнить - по согласованию с клиентом - последним предшествующим значением. Это легко сделать, если пропуск один. Но что сделать, если пропусков несколько подряд?

На помощь придёт **FILTER в сочетании  оконной функцией** (в ClickHouse это работает).

Мы будем искать последнее значение - LAST_VALUE - отфильтровывая строки на ходу через FILTER. То есть мы будем брать только те строки, где число подписчиков не равно 0, и среди них искать последнее значение. В OVER мы прописываем разделение данных по соцсетям, упорядочиваем их по соцсетям и по возрастанию даты, и смотрим на все предшествующие строки и текущую. В итоге получается: если текущая строка не была 0, она остаётся со своим значением. А если была 0 - то заполняется последним ненулевым значением из предшествующих строк.

    LAST_VALUE(followers) FILTER (WHERE followers !=0)
			  OVER (PARTITION BY socSource
			  ORDER BY socSource, socDate
			  ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS followers_fixed

Таким образом в ClickHouse можно решить задачу на заполнение пропусков последним имеющимся значением при любом количестве пропусков подряд. Возможно, в другой базе данных подобную задачу можно решить лаконичнее через GROUPS BETWEEN (ClickHouse такое не поддерживает) или каким-то ещё более интересным способом. 
