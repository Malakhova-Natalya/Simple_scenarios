## ClickHouse: сгенерировать строки с датами, имея дату начала и дату конца периода

**Варианты решения**: [здесь](https://github.com/Malakhova-Natalya/Snippets/blob/main/clickhouse_date_range/01%20-%20генерация%20строк%20с%20датами.txt)

## ClickHouse: заменить пропуски последним значением

Рабочая ситуация: есть данные из JagaJam. В них для соцсетей (VK, TG) есть данные об активности пользователей. Например, дата, соцсеть, кол-во подписчиков, кол-во просмотров, лайков, комментариев и тд. Но если в какую-либо дату активностей не было → не будет строки. Поэтому для не очень активных групп бывают ситуации, когда активности не было → не было строки с такой датой → и если мы строим график с числом подписчиков, у нас из-за этого появляются пробелы. А это неверно - раз активности не было, это не значит, что все подписчики испарились в эту дату. К тому же, график с пробелами не устраивает клиента.

Получается, у нас есть некоторое количество пропусков, которые нужно заполнить.
Сначала мы генерируем даты и присоединяем даты без пропусков к основным данным. (Варианты решения [здесь](https://github.com/Malakhova-Natalya/Snippets/blob/main/clickhouse_date_range/01%20-%20генерация%20строк%20с%20датами.txt)).

Затем у нас есть все даты, но в некоторые нам не хватает подписчиков. Чтобы на графике не было пропусков, нам нужно их заполнить - по согласованию с клиентом - последним предшествующим значением. Это легко сделать, если пропуск один. Но что сделать, если пропусков несколько подряд?

На помощь придёт **FILTER в сочетании  оконной функцией** (в ClickHouse это работает).

Мы будем искать последнее значение - LAST_VALUE - отфильтровывая строки на ходу через FILTER. То есть мы будем брать только те строки, где число подписчиков не равно 0, и среди них искать последнее значение. В OVER мы прописываем разделение данных по соцсетям, упорядочиваем их по соцсетям и по возрастанию даты, и смотрим на все предшествующие строки и текущую. В итоге получается: если текущая строка не была 0, она остаётся со своим значением. А если была 0 - то заполняется последним ненулевым значением из предшествующих строк.

    LAST_VALUE(followers) FILTER (WHERE followers !=0)
			  OVER (PARTITION BY socSource
			  ORDER BY socSource, socDate
			  ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS followers_fixed

Результат работы функции:
     
	dt	   	followers 	followers_fixed
	2024-02-23 	20452		20452
	2024-02-24 	20445		20445
	2024-02-25 	0		20445
	2024-02-26 	20436		20436
	2024-02-27 	20423		20423
	2024-02-28 	20408		20408
	2024-02-29 	20388		20388
	2024-03-01 	0		20388
	2024-03-02 	0		20388
	2024-03-03 	0		20388
	2024-03-04 	0		20388
	2024-03-05 	0		20388
	2024-03-06 	20375		20375
	2024-03-07 	20371		20371
	2024-03-08 	20360		20360
	2024-03-09 	20349		20349


Таким образом в ClickHouse можно решить задачу на заполнение пропусков последним имеющимся значением при любом количестве пропусков подряд. Возможно, в другой базе данных подобную задачу можно решить лаконичнее через GROUPS BETWEEN (ClickHouse такое не поддерживает) или каким-то ещё более интересным/простым способом. 
