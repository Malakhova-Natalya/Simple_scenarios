## ClickHouse: сгенерировать строки с датами, имея дату начала и дату конца периода

**Варианты решения**: [здесь](https://github.com/Malakhova-Natalya/Snippets/blob/main/clickhouse_date_range/01%20-%20генерация%20строк%20с%20датами.txt)

## ClickHouse: заменить пропуски последним значением

Рабочая ситуация: есть данные из JagaJam. В них для соцсетей (VK, TG) есть данные об активности пользователей. Например, дата, соцсеть, кол-во подписчиков, кол-во просмотров, лайков, комментариев и тд. Но если в какую-либо дату активностей не было → не будет строки. Поэтому для не очень активных групп бывают ситуации, когда активности не было → не было строки с такой датой → и если мы строим график с числом подписчиков, у нас из-за этого появляются провалы. А это неверно - раз активности не было, это не значит, что все подписчики испарились в эту дату.

Получается, у нас есть некоторое количество пропусков, которые нужно заполнить.
Сначала мы генерируем даты и присоединяем даты без пропусков к основным данным. (Варианты решения [здесь](https://github.com/Malakhova-Natalya/Snippets/blob/main/clickhouse_date_range/01%20-%20генерация%20строк%20с%20датами.txt)).

Затем у нас есть все даты, но в некоторые нам не хватает подписчиков. Чтобы на графике не было пропусков, нам нужно их заполнить - по согласованию с клиентом - последним предшествующим значением. Это легко сделать, если пропуск один. Но что сделать, если пропусков несколько подряд?

На помощь придёт FILTER  в сочетании  оконной функцией.


Для начала мы добавляем к нашим данным столбец is_null, где укажем, имеет ли эта строка 0 подписчиков или нет:

    SELECT *, 
    CASE WHEN followers==0 THEN 1 ELSE 0 END AS is_null
    FROM my_table

Затем мы будем искать последнее значение - LAST_VALUE - отфильтровывая строки на ходу через FILTER. То есть мы будем брать только те строки, которые не являются пропуском, и среди них искать последнее значение. Ну и напоследокпрописываем OVER, где мы разделяем данные по соцсетям, упорядочиваем их по возрастанию даты, и заставляем оконную функцию смотреть, например, среди 10 предшествующих строк.

    SELECT *, 
    LAST_VALUE(followers) FILTER (WHERE is_null !=1) 
              OVER (PARTITION BY socSource 
              ORDER BY socSource, socDate 
              ROWS BETWEEN 10 PRECEDING AND CURRENT ROW) 
      AS followers_fixed
    FROM (
    SELECT *, 
    CASE WHEN followers==0 THEN 1 ELSE 0 END AS is_null
    FROM my_table
    )
    ORDER BY socSource, socDate

Таким образом в ClickHouse можно решить подобную задачу на заполнение пропусков последним имеющимся значением.
